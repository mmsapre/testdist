package com.acme.graavl.distribution;

import com.acme.graavl.audit.*;
import com.acme.graavl.config.AppConfig.AppProps;
import org.springframework.boot.ApplicationRunner;
import org.springframework.context.annotation.Bean;
import org.springframework.stereotype.Component;
import reactor.core.scheduler.Schedulers;

@Component
public class DistributionBootstrap {

  @Bean
  public ApplicationRunner runner(AppProps props,
                                  AuditSchemaEnsurer ensurer,
                                  AuditRingBufferR2dbcWriter writer,
                                  PendingPublishReplayer replayer,
                                  PipelineRunner pipelineRunner,
                                  SolaceConsumerStub solaceStub) {
    return args -> {

      // 1) Ensure table
      if (props.distribution.audit.ensureTableOnStartup) {
        ensurer.ensure().block();
      }

      // 2) Start RB -> DB writer loop (non-blocking)
      writer.start()
          .subscribeOn(Schedulers.boundedElastic())
          .subscribe();

      // 3) Replay pending publishes first
      if (props.distribution.audit.startupReplay.enabled) {
        replayer.fetchPending(props.distribution.audit.startupReplay.batchSize)
            .concatMap(item -> pipelineRunner.republish(item.dataKey(), item.loadRowId(), item.requestId()))
            .blockLast();
      }

      // 4) Start consumer AFTER replay
      if (props.distribution.solace.enabled && props.distribution.solace.startStubProducer) {
        solaceStub.start();
      }
    };
  }
}

package com.acme.graavl.distribution;

import com.acme.graavl.audit.AuditRingBufferPublisher;
import com.acme.graavl.config.AppConfig.AppProps;
import com.acme.graavl.model.DistributionAuditEvent;
import com.acme.graavl.model.DistributionState;
import org.springframework.stereotype.Component;

import java.util.Random;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

@Component
public class SolaceConsumerStub {

  private final AppProps props;
  private final AuditRingBufferPublisher audit;
  private final PipelineRunner runner;

  private final Random rnd = new Random();

  public SolaceConsumerStub(AppProps props, AuditRingBufferPublisher audit, PipelineRunner runner) {
    this.props = props;
    this.audit = audit;
    this.runner = runner;
  }

  public void start() {
    var exec = Executors.newSingleThreadScheduledExecutor();
    exec.scheduleAtFixedRate(() -> {
      String dataKey = "DK-" + (100 + rnd.nextInt(3));
      long loadRowId = System.currentTimeMillis();
      String requestId = null; // if non-null, bypass dedupe in your publisher logic

      audit.publish(DistributionAuditEvent.of(
          loadRowId, dataKey, props.distribution.serviceName,
          DistributionState.RECEIVED,
          "Solace event received",
          requestId
      ));

      runner.runFromSolace(dataKey, loadRowId, requestId).subscribe();

    }, 1000, 2000, TimeUnit.MILLISECONDS);
  }
}
